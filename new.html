<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü•ó</text></svg>">
    
    <title>NutriFind: Accurate Recipe Nutrition Calculator | Calorie and Macro Counter</title>
    <meta name="description" content="Calculate detailed nutrition facts (calories, fat, carbs, protein, fiber, sugar, sodium, saturated fat) for any recipe ingredient list using natural language processing. Includes a kitchen unit conversion tool." />
    <meta name="author" content="[Your Name or Company Name]" />
    <meta property="og:title" content="NutriFind: Accurate Recipe Nutrition Calculator" />
    <meta property="og:description" content="Calculate detailed nutrition facts for any recipe. Includes macro tracking and a kitchen unit conversion tool." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://nutrifind.fit/" /> 
    <meta property="og:image" content="https://placehold.co/1200x630/0a7c36/ffffff?text=NutriFind+Calculator" />
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2553227651137870"
        crossorigin="anonymous"></script>
        
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* --- Theme Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary: #0a7c36;
            --background: #f4f7f8;
            --text-color: #222;
            --card-bg: white;
            --border-color: #e5e7eb;
            --accent: #222;
        }
        
        .dark {
            --background: #1f2937;
            --text-color: #f3f4f6;
            --card-bg: #374151;
            --border-color: #4b5563;
            --accent: #f3f4f6;
        }

        /* --- Global Styles using Variables --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--background);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }
        
        header { background: var(--card-bg); }
        .bg-white { background-color: var(--card-bg) !important; }
        .border-gray-100, .border-gray-200 { border-color: var(--border-color); }
        .text-gray-800, .text-gray-700, .text-gray-600, .text-gray-500 { color: var(--text-color) !important; }
        
        /* Input Colors */
        input, select {
            background-color: var(--background);
            color: var(--text-color);
            border-color: var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Custom Nutrition Label Styling */
        .nutrition-label {
            width: 100%;
            border: 2px solid var(--accent);
            padding: 5px 15px;
            margin-top: 20px;
            background: var(--card-bg);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .label-header { 
            font-size: 28px; 
            font-weight: 900; 
            margin: 5px 0 0;
            padding-bottom: 5px;
            border-bottom: 10px solid var(--accent); 
            transition: border-color 0.3s;
        }
        .line { 
            padding: 4px 0; 
            border-bottom: 1px solid var(--accent); 
            overflow: hidden; 
            font-size: 14px; 
            transition: border-color 0.3s;
        }
        .line span { float: right; font-weight: bold; }
        .line.thick { border-bottom-width: 3px; }
        .line.no-border { border-bottom: none; }
        .line.indent { margin-left: 15px; }
        
        /* Custom Styles for Buttons */
        .calc-btn, .share-btn, .add-btn, .copy-ingredients-btn { 
            background-color: var(--primary); 
            color: white; 
            transition: background-color 0.2s;
        }
        .calc-btn:hover, .share-btn:hover, .add-btn:hover, .copy-ingredients-btn:hover { 
            background-color: #08662a; 
        }
        .delete-btn {
            background-color: #dc2626; 
            color: white;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #b91c1c; 
        }
        
        /* --- Theme Toggle Button --- */
        .theme-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, transform 0.1s;
        }
        .theme-toggle-btn:active {
            transform: scale(0.95);
        }
        
        /* Section styles */
        .info-section {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .saved-recipe-item {
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background-color: var(--background);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="text-center p-6 bg-white w-full shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-800">ü•ó NutriFind Recipe Calculator</h1>
        <p class="text-sm text-gray-500 mt-1">Analyze the nutrition of your recipes using natural language.</p>
    </header>
    
    <div class="container p-4 w-full max-w-2xl flex-grow">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Recipe Ingredients</h2>
            
            <div id="error-message" class="hidden p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm" role="alert">
                <span class="font-bold">Error:</span> No valid ingredients were successfully analyzed. Please check your query format (e.g., "1 cup flour" or "100g chicken breast").
            </div>
            
            <div id="ingredientsContainer"></div>
            
            <div class="flex flex-wrap gap-3 mt-4">
                <button class="add-btn flex-grow md:flex-grow-0 py-2 px-4 text-sm font-medium rounded-lg" onclick="addIngredient()">+ Add Ingredient</button>
                <button class="copy-ingredients-btn flex-grow md:flex-grow-0 py-2 px-4 text-sm font-medium rounded-lg" onclick="copyIngredients()">Copy Ingredients</button>
                <button class="calc-btn flex-grow py-2 px-4 text-lg font-bold rounded-lg" onclick="calculateRecipe()">Calculate Nutrition</button>
            </div>
        </div>

        <div id="resultsCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="display:none;">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Results Summary (Total Recipe)</h2>

            <div class="nutrition-label">
                <h3 class="label-header">Nutrition Facts</h3>
                <div id="nutritionTable"></div>
            </div>

            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Macronutrient Breakdown (by weight)</h3>
                <canvas id="macroChart" class="rounded-lg border p-4"></canvas>
            </div>

            <div class="share-buttons flex flex-wrap gap-3 mt-4">
                <button class="share-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="saveRecipe()">üíæ Save Recipe</button>
                <button class="share-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="copyTable()">Copy Nutrition Table</button>
                <button class="share-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="shareTable()">Share Results</button>
            </div>
        </div>
        
        <div id="savedRecipesCard" class="bg-white p-6 rounded-xl shadow-lg mt-6 border border-gray-100" style="display:none;">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üìö My Saved Recipes</h2>
            <div id="savedRecipesList">
                </div>
        </div>


        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üî™ Kitchen Unit Converter</h2>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[100px]">
                    <label for="convertAmount" class="block text-xs font-medium text-gray-700">Amount</label>
                    <input type="number" id="convertAmount" class="w-full p-2 border border-gray-300 rounded-lg text-sm" value="1" min="0.1" oninput="convertUnit()">
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label for="convertFrom" class="block text-xs font-medium text-gray-700">From Unit</label>
                    <select id="convertFrom" class="w-full p-2 border border-gray-300 rounded-lg text-sm" onchange="convertUnit()">
                        <option value="cup">Cup</option>
                        <option value="tbsp">Tablespoon (tbsp)</option>
                        <option value="tsp">Teaspoon (tsp)</option>
                        <option value="ml">Milliliter (ml)</option>
                        <option value="l">Liter (l)</option>
                        <option value="fl_oz">Fluid Ounce (fl oz)</option>
                    </select>
                </div>
                <div class="text-2xl text-gray-500 pb-1">=</div>
                <div class="flex-1 min-w-[120px]">
                    <label for="convertTo" class="block text-xs font-medium text-gray-700">To Unit</label>
                    <select id="convertTo" class="w-full p-2 border border-gray-300 rounded-lg text-sm" onchange="convertUnit()">
                        <option value="tbsp">Tablespoon (tbsp)</option>
                        <option value="tsp">Teaspoon (tsp)</option>
                        <option value="ml">Milliliter (ml)</option>
                        <option value="l">Liter (l)</option>
                        <option value="fl_oz">Fluid Ounce (fl oz)</option>
                        <option value="cup">Cup</option>
                    </select>
                </div>
            </div>
            <p id="conversionResult" class="mt-4 text-lg font-bold text-gray-800">1.00 Cup = 16.00 Tablespoon (tbsp)</p>
            <p class="text-xs text-gray-500 mt-2">Note: This tool converts volume units only and is not suitable for weight (grams/ounces) conversion.</p>
        </div>


        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 border border-gray-100 space-y-4">
            
            <details class="border border-gray-200 rounded-lg p-3">
                <summary class="font-bold text-lg cursor-pointer text-gray-700">
                    üí° About NutriFind: Your Recipe Analyzer
                </summary>
                <div class="pt-3 text-sm text-gray-600 leading-relaxed border-t mt-3 pt-3 border-gray-100">
                    <h4 class="font-semibold mb-2">Our Mission: Making Nutrition Transparent and Accessible</h4>
                    <p>
                        NutriFind was created to solve the common challenge of tracking detailed nutrition for home-cooked meals. We utilize sophisticated **Natural Language Processing (NLP)** technology to interpret plain-text ingredient lists (e.g., "1.5 lbs ground beef," "1 tbsp olive oil"). This allows us to quickly query a robust nutrition database and provide a full nutrition facts label for your total recipe.
                    </p>
                    <h4 class="font-semibold mt-3 mb-2">Understanding Key Nutrition Metrics</h4>
                    <ul class="list-disc list-inside space-y-1 ml-4">
                        <li>
                            **Saturated Fat:** A type of fat primarily from animal sources. Monitoring this is important for cardiovascular health.
                        </li>
                        <li>
                            **Sodium (mg):** Essential for fluid balance, but intake should be moderated (generally under 2,300 mg daily).
                        </li>
                        <li>
                            **Dietary Fiber:** Crucial for digestive health and helps stabilize blood sugar levels.
                        </li>
                    </ul>
                </div>
            </details>

            <details class="border border-gray-200 rounded-lg p-3">
                <summary class="font-bold text-lg cursor-pointer text-gray-700">
                    üîí Privacy Policy
                </summary>
                <div class="pt-3 text-sm text-gray-600 leading-relaxed border-t mt-3 pt-3 border-gray-100">
                    <h4 class="font-semibold mb-2">Information We DO NOT Collect</h4>
                    <p>
                        We are committed to maximizing user privacy. **NutriFind does not collect, store, or transmit any personally identifiable information (PII) or sensitive user data.** This includes names, email addresses, IP addresses, or specific ingredient search history.
                    </p>
                    <h4 class="font-semibold mt-3 mb-2">Local Storage & Third-Party Services</h4>
                    <p>
                        Recipes are saved using your browser's **Local Storage** and are stored **entirely on your device**. They are never transmitted to our servers. We use third-party APIs (like CalorieNinja) for anonymous nutrition lookups and rely on services like Google AdSense, which may use cookies for personalized ads.
                    </p>
                </div>
            </details>

            <details class="border border-gray-200 rounded-lg p-3">
                <summary class="font-bold text-lg cursor-pointer text-gray-700">
                    ‚ö†Ô∏è Terms of Use & Health Disclaimer
                </summary>
                <div class="pt-3 text-sm text-gray-600 leading-relaxed border-t mt-3 pt-3 border-gray-100">
                    <h4 class="font-bold mb-2 text-red-600">HEALTH DISCLAIMER (CRITICAL)</h4>
                    <p>
                        The nutrition information provided by NutriFind is for **informational and educational purposes only**. The results are estimates based on third-party data and should **NOT** be considered a substitute for professional medical advice, diagnosis, or treatment from a qualified healthcare provider or registered dietitian. Accuracy is not guaranteed and results may vary.
                    </p>
                    <h4 class="font-semibold mt-3 mb-2">Terms of Use</h4>
                    <p>
                        By using this Service, you agree to these Terms. You shall not attempt to reverse engineer or overload the Service. You assume all risks associated with relying on the data provided by this tool.
                    </p>
                </div>
            </details>

        </div>
    
    <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle dark mode" onclick="toggleTheme()">
        </button>

    <footer class="sticky bottom-0 bg-white p-4 w-full text-center text-xs text-gray-500 border-t border-gray-200 mt-auto">
        NutriFind ¬© 2025 ¬∑ Data provided by CalorieNinja API.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script>
        
        // --- GLOBAL CONFIG ---
        const WEBSITE_URL = "https://nutrifind.fit/"; 
        const WEBSITE_TITLE = "NutriFind Recipe Calculator";

        // --- GLOBAL STATE ---
        window.lastCalculatedTotals = null; 
        let macroChartInstance = null;

        // --- THEME TOGGLE LOGIC (Unchanged) ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark');
                themeToggle.textContent = 'üåô';
            } else {
                themeToggle.textContent = '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'üåô';
            }
        }

        // --- INGREDIENT ROW LOGIC (Unchanged) ---
        function ingredientRowHTML() {
            return `
            <div class="ingredient-row flex gap-2 mb-2">
                <input type="text" class="query w-full p-2 border border-gray-300 rounded-lg text-sm" 
                       placeholder="e.g., 100g chicken breast or 2 liters water" 
                       value="" />
                <button class="bg-red-500 text-white rounded-lg p-2 text-sm hover:bg-red-600 w-10 flex-shrink-0" 
                        onclick="this.parentElement.remove()">‚úï</button>
            </div>`;
        }

        function addIngredient() {
            document.getElementById('ingredientsContainer').insertAdjacentHTML('beforeend', ingredientRowHTML());
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('ingredientsContainer').children.length === 0) {
                 document.getElementById('ingredientsContainer').insertAdjacentHTML('beforeend', ingredientRowHTML());
            }
            initializeTheme();
            convertUnit(); 
            loadSavedRecipes(); 
        });

        // --- API & CALCULATION LOGIC (Unchanged) ---
        async function getNutrition(query) {
            const maxRetries = 3;
            let currentRetry = 0;
            
            while (currentRetry < maxRetries) {
                try {
                    // NOTE: This fetch call assumes a server-side proxy exists at /api/nutrition 
                    // that handles the actual request to an external nutrition API (e.g., CalorieNinja).
                    const res = await fetch(`/api/nutrition?query=${encodeURIComponent(query)}`);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return await res.json();
                } catch (error) {
                    currentRetry++;
                    if (currentRetry >= maxRetries) {
                        return { items: [] };
                    }
                    const delay = Math.pow(2, currentRetry) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function calculateRecipe() {
            const rows = document.querySelectorAll('.ingredient-row');
            let totals = { cal: 0, fat: 0, carb: 0, protein: 0, sodium: 0, fiber: 0, sugar: 0, sat_fat: 0 };
            let successfulLookups = 0;
            document.getElementById('error-message').style.display = 'none'; 

            const calcBtn = document.querySelector('.calc-btn');
            const originalText = calcBtn.textContent;
            calcBtn.textContent = 'Calculating...';
            calcBtn.disabled = true;

            for (const row of rows) {
                const queryInput = row.querySelector('.query');
                if (!queryInput) continue;
                
                const query = queryInput.value.trim();
                if (!query || query.length < 3) continue; 
                
                const data = await getNutrition(query);

                if (data.items && data.items.length) {
                    const item = data.items[0];
                    totals.cal += item.calories || 0;
                    totals.fat += item.fat_total_g || 0;
                    totals.sat_fat += item.fat_saturated_g || 0; 
                    totals.carb += item.carbohydrates_total_g || 0;
                    totals.protein += item.protein_g || 0;
                    totals.sodium += item.sodium_mg || 0;
                    totals.fiber += item.fiber_g || 0;
                    totals.sugar += item.sugar_g || 0;
                    
                    successfulLookups++;
                }
            }
            
            calcBtn.textContent = originalText;
            calcBtn.disabled = false;
            
            if (successfulLookups === 0) {
                document.getElementById('resultsCard').style.display = 'none';
                document.getElementById('error-message').style.display = 'block'; 
                window.lastCalculatedTotals = null;
                return;
            }

            window.lastCalculatedTotals = totals; 
            
            document.getElementById('resultsCard').style.display = 'block';
            updateNutritionTable(totals);
            updateMacroChart(totals);
        }

        // --- UPDATE TABLE & CHART LOGIC (Unchanged) ---
        function updateNutritionTable(totals) {
            const tableBody = document.getElementById('nutritionTable');
            const formatG = (val) => `${val.toFixed(1)} g`;
            const formatMG = (val) => `${Math.round(val)} mg`;
            const formatCal = (val) => `${Math.round(val)}`;

            tableBody.innerHTML = `
                <div class="line thick font-bold text-base">Calories <span>${formatCal(totals.cal)}</span></div>
                <div class="line thick font-bold text-base">Total Fat <span>${formatG(totals.fat)}</span></div>
                <div class="line indent">Saturated Fat <span>${formatG(totals.sat_fat)}</span></div>
                <div class="line thick font-bold text-base">Sodium <span>${formatMG(totals.sodium)}</span></div>
                <div class="line thick font-bold text-base">Total Carbohydrate <span>${formatG(totals.carb)}</span></div>
                <div class="line indent">Dietary Fiber <span>${formatG(totals.fiber)}</span></div>
                <div class="line indent">Total Sugars <span>${formatG(totals.sugar)}</span></div>
                <div class="line thick font-bold text-base no-border">Protein <span>${formatG(totals.protein)}</span></div>
            `;
        }

        function updateMacroChart(totals) {
            const ctx = document.getElementById("macroChart").getContext("2d");
            if (macroChartInstance) macroChartInstance.destroy();

            const macroData = [totals.fat, totals.carb, totals.protein];
            const totalMacros = totals.fat + totals.carb + totals.protein;
            const pastelColors = ["#FFC3A0", "#C6E2FF", "#D7FFC6"]; 

            macroChartInstance = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Fat (g)", "Carbs (g)", "Protein (g)"],
                    datasets: [{
                        data: macroData,
                        backgroundColor: pastelColors,
                        hoverOffset: 15,
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-color)',
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = totalMacros > 0 ? ((value / totalMacros) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label}: ${value.toFixed(1)}g (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: isNaN(value),
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Macronutrient Split (by weight in grams)',
                            color: 'var(--text-color)',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toFixed(1)}g (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- RECIPE SAVING & LOADING LOGIC (Unchanged) ---
        function saveRecipe() {
            let savedRecipes = JSON.parse(localStorage.getItem('nutrifind_recipes') || '[]');
            const currentIngredients = Array.from(document.querySelectorAll('.ingredient-row .query'))
                                           .map(input => input.value.trim())
                                           .filter(val => val.length > 0);
            
            if (currentIngredients.length === 0 || !window.lastCalculatedTotals) {
                alert("Please calculate the recipe nutrition before saving.");
                return;
            }

            const recipeName = prompt("Enter a name for your recipe (e.g., 'Mom's Chicken Soup'):");
            if (!recipeName || recipeName.trim() === "") {
                return; 
            }
            
            const newRecipeId = Date.now(); 

            const newRecipe = {
                id: newRecipeId, 
                name: recipeName.trim(),
                ingredients: currentIngredients,
                totals: window.lastCalculatedTotals,
                date: new Date().toLocaleDateString()
            };

            savedRecipes.unshift(newRecipe); 
            localStorage.setItem('nutrifind_recipes', JSON.stringify(savedRecipes));

            alert(`Recipe "${newRecipe.name}" saved successfully!`);
            renderSavedRecipes(savedRecipes); 
        }
        
        function loadSavedRecipes() {
            const savedRecipes = JSON.parse(localStorage.getItem('nutrifind_recipes') || '[]');
            renderSavedRecipes(savedRecipes);
        }

        function renderSavedRecipes(recipes) {
            const listContainer = document.getElementById('savedRecipesList');
            const card = document.getElementById('savedRecipesCard');
            listContainer.innerHTML = ''; 

            if (recipes.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            recipes.forEach(recipe => {
                const ingredientsPreview = recipe.ingredients.slice(0, 3).join(', ') + (recipe.ingredients.length > 3 ? '...' : '');
                const html = `
                    <div class="saved-recipe-item flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h4 class="font-bold text-lg">${recipe.name}</h4>
                            <p class="text-sm text-gray-600">
                                **Cal:** ${Math.round(recipe.totals.cal)} | 
                                **P:** ${recipe.totals.protein.toFixed(1)}g | 
                                **C:** ${recipe.totals.carb.toFixed(1)}g | 
                                **F:** ${recipe.totals.fat.toFixed(1)}g 
                            </p>
                            <p class="text-xs text-gray-500 mt-1 italic">
                                Ingredients: ${ingredientsPreview}
                            </p>
                        </div>
                        <div class="flex gap-2 mt-3 sm:mt-0">
                            <button class="share-btn py-1 px-3 text-sm font-medium rounded-lg" onclick="alert('Viewing ingredients:\\n${recipe.ingredients.join('\\n')}')">View</button>
                            <button class="delete-btn py-1 px-3 text-sm font-medium rounded-lg" onclick="deleteRecipe(${recipe.id})">Delete</button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }
        
        function deleteRecipe(id) {
            let savedRecipes = JSON.parse(localStorage.getItem('nutrifind_recipes') || '[]');
            savedRecipes = savedRecipes.filter(recipe => recipe.id !== id);
            localStorage.setItem('nutrifind_recipes', JSON.stringify(savedRecipes));
            renderSavedRecipes(savedRecipes); 
            alert('Recipe deleted successfully.');
        }


        // --- UNIT CONVERSION (Unchanged) ---
        const CONVERSION_FACTORS = {
            'ml': 1, 'tsp': 4.92892, 'tbsp': 14.7868, 'fl_oz': 29.5735, 'cup': 236.588, 'l': 1000 
        };

        function convertUnit() {
            const amountInput = document.getElementById('convertAmount');
            const fromUnit = document.getElementById('convertFrom').value;
            const toUnit = document.getElementById('convertTo').value;
            const resultDisplay = document.getElementById('conversionResult');
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                resultDisplay.textContent = "Please enter a valid amount.";
                return;
            }

            const baseUnitFactor = CONVERSION_FACTORS[fromUnit];
            const amountInML = amount * baseUnitFactor;
            const targetUnitFactor = CONVERSION_FACTORS[toUnit];
            const result = amountInML / targetUnitFactor;
            
            const fromUnitLabel = document.getElementById('convertFrom').options[document.getElementById('convertFrom').selectedIndex].text;
            const toUnitLabel = document.getElementById('convertTo').options[document.getElementById('convertTo').selectedIndex].text;

            resultDisplay.textContent = `${amount.toFixed(2)} ${fromUnitLabel} = ${result.toFixed(2)} ${toUnitLabel}`;
        }
        
        // --- COPY & SHARE UTILITIES ---
        function copyIngredients() {
            const rows = document.querySelectorAll('.ingredient-row');
            let ingredientsList = [];
            rows.forEach(row => {
                const queryInput = row.querySelector('.query');
                const query = queryInput.value.trim();
                if (query) { ingredientsList.push(query); }
            });
            const textToCopy = ingredientsList.join('\n');
            if (textToCopy.length === 0) { return; }
            try {
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                const copyBtn = document.querySelector('.copy-ingredients-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = originalText; }, 1500);
            } catch (err) {
                console.error('Could not copy ingredients: ', err);
            }
        }
        
        function copyTable() { 
            const recipeName = document.querySelector('h2.text-xl').textContent.includes('Total Recipe') 
                               ? 'Recipe Summary' : document.querySelector('h2.text-xl').textContent;

            // Header includes the website title and URL
            const header = `[${WEBSITE_TITLE}] - ${recipeName}\n${WEBSITE_URL}\n---\n`;
            
            const tableText = document.getElementById("nutritionTable").innerText;
            const textToCopy = header + tableText;
            
            try {
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                const copyBtn = document.querySelector('button[onclick="copyTable()"]');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 1500);

            } catch (err) { console.error('Could not copy text: ', err); }
        }

        // --- UTILITY: Share Table (FINAL STABLE: TEXT-ONLY, ENGAGING CTA) ---
async function shareTable() { 
    if (!window.lastCalculatedTotals) {
        alert("Please calculate the recipe nutrition before sharing.");
        return;
    }
    
    const t = window.lastCalculatedTotals;
    
    // 1. Generate the clean, templated text. 
    // The explicit URL is excluded from the text body to prevent duplication.
    const shareBody = `Check out my recipe nutrition facts from ${WEBSITE_TITLE}.\n\n` +
                      `*Calories - ${Math.round(t.cal)}*\n` +
                      `Total Fat - ${t.fat.toFixed(1)} g\n` +
                      `Saturated Fat - ${t.sat_fat.toFixed(1)} g\n` +
                      `Sodium - ${Math.round(t.sodium)} mg\n` +
                      `Total Carbohydrate - ${t.carb.toFixed(1)} g\n` +
                      `Dietary Fiber - ${t.fiber.toFixed(1)} g\n` +
                      `Total Sugars - ${t.sugar.toFixed(1)} g\n` +
                      `Protein - ${t.protein.toFixed(1)} g\n\n` + 
                      `Get started on your own recipes! `; 

    if (navigator.share) { 
        try {
            await navigator.share({ 
                title: `${WEBSITE_TITLE} Results`, 
                text: shareBody,
                // The URL is included here to trigger the Rich Link Preview box at the top.
                url: WEBSITE_URL 
            });
        } catch (error) {
            console.error('Sharing failed or cancelled:', error);
        }
    } else { 
        alert(`Sharing not supported. Please use the 'Copy Nutrition Table' button or visit ${WEBSITE_URL}`); 
    }
}
    </script>
</body>
</html>
