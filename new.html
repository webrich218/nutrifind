<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Favicon (Salad Emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥—</text></svg>">
    
    <!-- SEO & Metadata -->
    <title>NutriFind: Accurate Recipe Nutrition Calculator | Calorie and Macro Counter</title>
    <meta name="description" content="Calculate detailed nutrition facts (calories, fat, carbs, protein, fiber, sugar, sodium) for any recipe ingredient list using natural language processing." />
    <meta name="keywords" content="nutrition calculator, recipe analyzer, macro counter, calorie counter, food ingredients, diet planning, CalorieNinja, recipe nutrition facts, accurate calorie count" />
    
    <!-- Open Graph (for social sharing previews) -->
    <meta property="og:title" content="NutriFind: Accurate Recipe Nutrition Calculator" />
    <meta property="og:description" content="Calculate detailed nutrition facts (calories, fat, carbs, protein, fiber, sugar, sodium) for any recipe ingredient list using natural language processing." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="YOUR_LIVE_URL_HERE" />
    <!-- Replace with a thumbnail image for your app -->
    <meta property="og:image" content="https://placehold.co/1200x630/0a7c36/ffffff?text=NutriFind+Calculator" /> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Theme Variables --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            /* Light Theme Defaults */
            --primary: #0a7c36;
            --background: #f4f7f8;
            --text-color: #222;
            --card-bg: white;
            --border-color: #e5e7eb;
            --accent: #222; /* Nutrition label line/border color */
        }
        
        .dark {
            /* Dark Theme Overrides */
            --background: #1f2937; /* Dark blue/gray */
            --text-color: #f3f4f6; /* Near white */
            --card-bg: #374151; /* Darker gray */
            --border-color: #4b5563;
            --accent: #f3f4f6;
        }

        /* --- Global Styles using Variables --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--background);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s;
        }
        .calc-btn, .add-btn { transition: background-color 0.2s; }
        
        /* Apply card backgrounds and borders */
        header { background: var(--card-bg); }
        .bg-white { background-color: var(--card-bg) !important; }
        .border-gray-100, .border-gray-200 { border-color: var(--border-color); }
        /* Fix for dark mode readability: All shades of gray text use the light text color in dark mode */
        .text-gray-800, .text-gray-700, .text-gray-600, .text-gray-500 { color: var(--text-color) !important; }
        
        /* Input/Select Colors */
        input, select {
            background-color: var(--background);
            color: var(--text-color);
            border-color: var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* Custom Nutrition Label Styling */
        .nutrition-label {
            width: 100%;
            border: 2px solid var(--accent);
            padding: 5px 15px;
            margin-top: 20px;
            background: var(--card-bg);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .label-header { 
            font-size: 28px; 
            font-weight: 900; 
            margin: 5px 0 0;
            padding-bottom: 5px;
            border-bottom: 10px solid var(--accent); 
            transition: border-color 0.3s;
        }
        .line { 
            padding: 4px 0; 
            border-bottom: 1px solid var(--accent); 
            overflow: hidden; 
            font-size: 14px; 
            transition: border-color 0.3s;
        }
        .line span { float: right; font-weight: bold; }
        .line.thick { border-bottom-width: 3px; }
        .line.no-border { border-bottom: none; }
        .line.indent { margin-left: 15px; }
        
        /* Custom Styles for Buttons */
        .copy-btn { background-color: var(--accent); }
        .copy-btn:hover { background-color: #555; }
        .calc-btn, .share-btn, .add-btn { background-color: var(--primary); }
        .calc-btn:hover, .share-btn:hover, .add-btn:hover { background-color: #08662a; }

        /* --- Theme Toggle Button --- */
        .theme-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s, transform 0.1s;
        }
        .theme-toggle-btn:active {
            transform: scale(0.95);
        }
        
        /* Section styles */
        .info-section {
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="text-center p-6 bg-white w-full shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-800">ðŸ¥— NutriFind Recipe Calculator</h1>
        <p class="text-sm text-gray-500 mt-1">Analyze the nutrition of your recipes using natural language.</p>
    </header>
    
    <div class="container p-4 w-full max-w-2xl">
        
        <!-- Ingredient Input Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Recipe Ingredients</h2>
            <div id="ingredientsContainer"></div>
            
            <div class="flex flex-wrap gap-3 mt-4">
                <button class="add-btn flex-grow md:flex-grow-0 py-2 px-4 text-sm font-medium rounded-lg" onclick="addIngredient()">+ Add Ingredient</button>
                <button class="calc-btn flex-grow py-2 px-4 text-lg font-bold rounded-lg" onclick="calculateRecipe()">Calculate Nutrition</button>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="display:none;">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Results Summary</h2>

            <!-- Nutrition Label Table -->
            <div class="nutrition-label">
                <h3 class="label-header">Nutrition Facts</h3>
                <div id="nutritionTable"></div>
            </div>

            <!-- Macro Chart -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Macronutrient Breakdown (by weight)</h3>
                <canvas id="macroChart" class="rounded-lg border p-4"></canvas>
            </div>

            <div class="share-buttons flex gap-3 mt-4">
                <button class="copy-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="copyTable()">Copy Nutrition Table</button>
                <button class="share-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="shareTable()">Share Results</button>
            </div>
        </div>

        <!-- About & Info Sections -->
        <div class="bg-white p-6 rounded-xl shadow-lg mt-6 border border-gray-100">
            
            <!-- 1. What is NutriFind? -->
            <div class="info-section">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">What is NutriFind?</h2>
                <p class="text-sm text-gray-600 leading-relaxed">
                    **NutriFind** is your powerful, free **recipe nutrition calculator** designed to simplify diet planning and tracking macros. We use advanced **natural language processing (NLP)** to accurately analyze the **calorie count**, **macro distribution (protein, fat, carbs)**, and full **nutrition facts** for any list of ingredients you provide. Whether you're meal prepping, managing a specific diet, or just curious about your favorite recipes, NutriFind offers a quick and **accurate calorie counter** solution, making it the essential **recipe analyzer** for home cooks and fitness enthusiasts alike.
                </p>
            </div>
            
            <!-- 2. How to Use the Recipe Calculator -->
            <div class="info-section">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">How to Use the Recipe Calculator</h2>
                <p class="text-sm text-gray-600 leading-relaxed">
                    Using NutriFind is simple. In the "Recipe Ingredients" section above, enter each ingredient on a new line. Be sure to specify the quantity and unit (e.g., "300g chicken breast", "1 tbsp olive oil", or "1 cup flour"). Our system handles complex measurements and unit conversions automatically. Once your ingredient list is complete, click the **"Calculate Nutrition"** button to instantly generate a detailed Nutrition Facts label and a graphical macronutrient breakdown chart for your entire recipe.
                </p>
            </div>
            
            <!-- 3. Privacy & Terms -->
            <div class="info-section border-b-0">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Privacy & Terms</h2>
                <p class="text-xs text-gray-500 leading-relaxed">
                    **Data Privacy:** At NutriFind, your privacy is paramount. We are committed to an anonymous experience; **we do not store or process any personal data.** Ingredient searches and calculations are anonymous and are processed solely to retrieve accurate nutrition results.
                    <br><br>
                    **Disclaimer:** By using this site, you acknowledge and agree that the nutrition information provided is for general informational and educational purposes only. The results are calculated based on a comprehensive database but may vary significantly based on specific product brands, preparation methods (e.g., frying vs. baking), and variations in ingredient sourcing. Always consult a medical or diet professional for personalized advice.
                </p>
            </div>

        </div>

    </div>
    
    <!-- Theme Toggle Button -->
    <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle dark mode" onclick="toggleTheme()">
        <!-- Initial content set by JavaScript -->
    </button>

    <footer class="sticky bottom-0 bg-white p-4 w-full text-center text-xs text-gray-500 border-t border-gray-200 mt-auto">
        NutriFind Â© 2025 Â· Data provided by CalorieNinja API.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script>
        
        // --- THEME TOGGLE LOGIC ---
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeToggle = document.getElementById('themeToggle');

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.body.classList.add('dark');
                themeToggle.textContent = 'ðŸŒ™';
            } else {
                themeToggle.textContent = 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'â˜€ï¸';
            } else {
                body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'ðŸŒ™';
            }
        }
        // --- END THEME TOGGLE LOGIC ---


        // Set up the initial ingredient row and theme on load
        document.addEventListener('DOMContentLoaded', () => {
            addIngredient();
            initializeTheme();
        });

        function ingredientRowHTML() {
            return `
            <div class="ingredient-row flex gap-2 mb-2">
                <input type="text" class="food w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Chicken breast" />
                <input type="number" class="amount p-2 border border-gray-300 rounded-lg w-20 text-sm" placeholder="Amount" value="100" min="0.1" />
                <select class="unit p-2 border border-gray-300 rounded-lg text-sm w-20">
                    <option value="g">g</option>
                    <option value="mg">mg</option>
                    <option value="oz">oz</option>
                    <option value="cup">cup</option>
                    <option value="tbsp">tbsp</option>
                    <option value="tsp">tsp</option>
                    <option value="piece">pc</option>
                </select>
                <button class="bg-red-500 text-white rounded-lg p-2 text-sm hover:bg-red-600 w-10 flex-shrink-0" onclick="this.parentElement.remove()">âœ•</button>
            </div>`;
        }

        function addIngredient() {
            document.getElementById('ingredientsContainer').insertAdjacentHTML('beforeend', ingredientRowHTML());
        }

        // --- API CALL ---
        async function getNutrition(query) {
            // Using exponential backoff for retries
            const maxRetries = 3;
            let currentRetry = 0;
            
            while (currentRetry < maxRetries) {
                try {
                    // Call the secure Vercel proxy endpoint
                    const res = await fetch(`/api/nutrition?query=${encodeURIComponent(query)}`);
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return await res.json();
                } catch (error) {
                    currentRetry++;
                    if (currentRetry >= maxRetries) {
                        console.error("Error fetching nutrition data from API proxy after retries:", error);
                        return { items: [] }; // Return empty data on final failure
                    }
                    // Wait with exponential backoff before retrying
                    const delay = Math.pow(2, currentRetry) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        let macroChartInstance = null;

        // --- MAIN CALCULATION ---
        async function calculateRecipe() {
            const rows = document.querySelectorAll('.ingredient-row');
            let totals = { cal: 0, fat: 0, carb: 0, protein: 0, sodium: 0, fiber: 0, sugar: 0 };
            let successfulLookups = 0;

            // Simple loading indicator on the button
            const calcBtn = document.querySelector('.calc-btn');
            const originalText = calcBtn.textContent;
            calcBtn.textContent = 'Calculating...';
            calcBtn.disabled = true;

            for (const row of rows) {
                const food = row.querySelector('.food').value.trim();
                const amt = row.querySelector('.amount').value;
                const unit = row.querySelector('.unit').value;
                
                if (!food || amt <= 0) continue;
                
                // CalorieNinja handles the quantity and unit in the query string
                const query = `${amt}${unit} ${food}`;
                const data = await getNutrition(query);

                if (data.items && data.items.length) {
                    const item = data.items[0];
                    // CalorieNinja uses a single item array for a single query
                    totals.cal += item.calories || 0;
                    totals.fat += item.fat_total_g || 0;
                    totals.carb += item.carbohydrates_total_g || 0;
                    totals.protein += item.protein_g || 0;
                    // Assuming CalorieNinja API returns these fields (common for full nutrition APIs)
                    totals.sodium += item.sodium_mg || 0;
                    totals.fiber += item.fiber_g || 0;
                    totals.sugar += item.sugar_g || 0; 
                    successfulLookups++;
                } else {
                    console.warn(`Could not find nutrition data for: ${query}`);
                }
            }
            
            calcBtn.textContent = originalText;
            calcBtn.disabled = false;
            
            if (successfulLookups === 0) {
                document.getElementById('resultsCard').style.display = 'none';
                // Using a console error, as per instructions to avoid alerts.
                console.error("No ingredients were successfully analyzed. Please check your spelling.");
                return;
            }

            document.getElementById('resultsCard').style.display = 'block';
            updateNutritionTable(totals);
            updateMacroChart(totals);
        }

        // --- UPDATE TABLE ---
        function updateNutritionTable(totals) {
            const tableBody = document.getElementById('nutritionTable');

            // Helper to format values
            const formatG = (val) => `${val.toFixed(1)} g`;
            const formatMG = (val) => `${Math.round(val)} mg`;
            const formatCal = (val) => `${Math.round(val)}`;

            // Build the Nutrition Facts table rows
            tableBody.innerHTML = `
                <div class="line thick font-bold text-base">
                    Calories <span>${formatCal(totals.cal)}</span>
                </div>
                <div class="line thick font-bold text-base">
                    Total Fat <span>${formatG(totals.fat)}</span>
                </div>
                <div class="line indent">
                    Saturated Fat <span>0 g</span>
                </div>
                <div class="line thick font-bold text-base">
                    Sodium <span>${formatMG(totals.sodium)}</span>
                </div>
                <div class="line thick font-bold text-base">
                    Total Carbohydrate <span>${formatG(totals.carb)}</span>
                </div>
                <div class="line indent">
                    Dietary Fiber <span>${formatG(totals.fiber)}</span>
                </div>
                <div class="line indent">
                    Total Sugars <span>${formatG(totals.sugar)}</span>
                </div>
                <div class="line thick font-bold text-base no-border">
                    Protein <span>${formatG(totals.protein)}</span>
                </div>
            `;
        }

        // --- UPDATE CHART ---
        function updateMacroChart(totals) {
            const ctx = document.getElementById("macroChart").getContext("2d");
            if (macroChartInstance) macroChartInstance.destroy();

            const macroData = [totals.fat, totals.carb, totals.protein];
            const totalMacros = totals.fat + totals.carb + totals.protein;

            // Pastel Colors
            const pastelColors = ["#FFC3A0", "#C6E2FF", "#D7FFC6"]; 

            macroChartInstance = new Chart(ctx, {
                type: "doughnut", // Changed to Donut style
                data: {
                    labels: ["Fat (g)", "Carbs (g)", "Protein (g)"],
                    datasets: [{
                        data: macroData,
                        backgroundColor: pastelColors,
                        hoverOffset: 15,
                        borderWidth: 2,
                        borderColor: 'var(--card-bg)', // Use card-bg variable for border
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'var(--text-color)', // Use text-color variable
                                // Add percentage to legend labels
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = totalMacros > 0 ? ((value / totalMacros) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label}: ${value.toFixed(1)}g (${percentage}%)`, // Display name, value, and percentage
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: isNaN(value),
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Macronutrient Split (by weight in grams)',
                            color: 'var(--text-color)', // Use text-color variable
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toFixed(1)}g (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- UTILITIES ---
        function copyTable() { 
            const tableText = "Nutrition Facts\n" + document.getElementById("nutritionTable").innerText;
            // Use document.execCommand('copy') for better compatibility in iframe environments
            try {
                const textarea = document.createElement('textarea');
                textarea.value = tableText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                // Custom alert replacement
                console.log("Nutrition facts copied to clipboard!"); 
            } catch (err) {
                console.error('Could not copy text: ', err);
            }
        }

        async function shareTable() { 
            const tableText = "Check out my recipe nutrition facts from NutriFind:\n" + document.getElementById("nutritionTable").innerText;
            if (navigator.share) { 
                await navigator.share({ 
                    title: 'NutriFind Recipe Facts', 
                    text: tableText 
                }); 
            } else { 
                // Custom alert replacement
                console.log("Sharing not supported on this browser. Use the Copy button instead."); 
            }
        }
    </script>
</body>
</html>
